{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}

{% include "navbar.html" %}

<div class="w-full max-w-[1440px] mx-auto bg-white overflow-hidden">
    
    <!-- HERO SECTION -->
    <div class="w-full px-6 py-16 sm:py-28 bg-gradient-to-b from-Light-Navy to-Flash-White flex flex-col items-center gap-12 sm:gap-20">
        <div class="w-full max-w-[1280px] flex flex-col items-start gap-12 sm:gap-20">
            
            <!-- HEADER SECTION -->
            <div class="w-full flex flex-col lg:flex-row justify-start items-center lg:items-start gap-8 lg:gap-16">
                
                <!-- LEFT COLUMN: Details -->
                <div class="flex-1 w-full flex flex-col items-start gap-8">
                    <div class="self-stretch flex flex-col items-start gap-6">
                        
                        <!-- Breadcrumb -->
                        <nav aria-label="Breadcrumb" class="self-stretch flex items-center gap-2 text-sm text-Flash-White">
                            <a href="#" class="hover:underline font-normal font-['Roboto'] leading-tight">All Venue</a>
                            <svg class="size-4 shrink-0" width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path d="M6.25854 5.34814L9.72534 8.71729C9.77811 8.7816 9.78589 8.80029 9.80151 8.8833C9.78589 8.96631 9.77807 8.98506 9.72534 9.04932L6.41187 12.3618C6.3161 12.4282 6.19961 12.424 6.08765 12.3452C6.01538 12.2415 6.01545 12.1073 6.08765 12.0044L9.20874 8.8833L6.07104 5.74463C6.00562 5.64885 6.00987 5.53237 6.08765 5.42041C6.14502 12.4026 6.19961 12.424 6.26245 12.4263C6.3161 12.4282 6.36016 12.4134 6.41187 12.3618L9.72534 9.04932C9.76134 9.0133 9.77807 8.98506 9.78589 8.96631C9.79576 8.94264 9.80147 8.9157 9.80151 8.8833C9.80151 8.85089 9.79571 8.82397 9.78589 8.80029C9.77811 8.7816 9.76116 8.75319 9.72534 8.71729L6.42847 5.42041C6.37656 5.36868 6.32559 5.34816 6.25854 5.34814Z" fill="currentColor" stroke="currentColor" stroke-width="0.666667"/>
                            </svg>
                            <span class="font-semibold font-['Roboto'] leading-tight">{{ venue.name }}</span>
                        </nav>

                        <!-- Title -->
                        <h1 class="self-stretch text-Flash-White text-4xl font-bold font-['Roboto'] leading-[48px]">
                            {{ venue.name }}
                        </h1>

                        <!-- Price & Rating -->
                        <div class="inline-flex items-center gap-4">
                            <span class="text-white text-2xl font-bold font-['Roboto'] leading-loose">
                                Rp{{ venue.price }} 
                                <span class="text-sm text-Flash-White font-light">/jam</span>
                            </span>
                            
                            <span class="h-10 w-px bg-Color-Scheme-1-Border" aria-hidden="true"></span>
                            
                            <div class="inline-flex flex-col items-start gap-1">
                                <div class="flex items-center gap-1">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="..."/>
                                    </svg>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="..."/>
                                    </svg>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="..."/>
                                    </svg>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="..." stroke="currentColor"/>
                                    </svg>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="..."/>
                                    </svg>
                                </div>
                                <span class="text-center text-white text-sm font-normal font-['Roboto'] leading-tight">
                                    (3.5 stars) â€¢ 10 reviews
                                </span>
                            </div>
                        </div>
                        
                        <!-- Details Section -->
                        <div class="self-stretch flex flex-col items-start gap-6">
                            <div class="w-fit pt-2 border-b border-black">
                                <div class="inline-flex flex-col items-start gap-2">
                                    <span class="text-white text-base font-normal font-['Roboto'] leading-normal">Details</span>
                                    <div class="w-full h-0.5 bg-Color-Scheme-1-Accent"></div> 
                                </div>
                            </div>
                            <div class="self-stretch text-white text-base font-normal font-['Roboto'] leading-normal">
                                {{ venue.description }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CENTER COLUMN: Image -->
                <div class="w-full max-w-[490px] lg:w-[490px] flex flex-col items-start gap-4">
                    <div class="self-stretch">
                        <img class="w-full h-auto aspect-square object-cover" src="{{ venue.image_url }}" alt="Venue Image" />
                    </div>
                </div>

                <!-- RIGHT COLUMN: Location & Booking -->
                <div class="flex-1 w-full flex flex-col items-start gap-6">
                    
                    <!-- Location Section -->
                    <div class="self-stretch flex flex-col items-start gap-6">
                        <div class="w-fit pt-2 border-b border-black">
                            <div class="inline-flex flex-col items-start gap-2">
                                <span class="text-white text-base font-normal font-['Roboto'] leading-normal">Location</span>
                                <div class="w-full h-0.5 bg-Color-Scheme-1-Accent"></div>
                            </div>
                        </div>
                        <div class="self-stretch text-white text-base font-normal font-['Roboto'] leading-normal">
                            {{ venue.address }}
                        </div>
                    </div>
                    
                    <!-- Type & Variant Section -->
                    <div class="self-stretch flex flex-col items-start gap-6">
                        
                        <!-- Type -->
                        <div class="self-stretch flex items-start gap-8">
                            <span class="text-white text-base font-normal font-['Roboto'] leading-normal mt-2">Type</span>
                            <div class="flex-1 flex flex-wrap gap-4">
                                <button type="button" class="px-4 py-2 outline outline-1 outline-Color-Neutral-Darkest text-Color-Neutral-Darkest text-base font-normal font-['Roboto'] leading-normal">
                                    {{ venue.type }}
                                </button>
                            </div>
                        </div>

                        <!-- Variant & Quantity -->
                        <div class="self-stretch flex flex-col sm:flex-row items-start gap-4">
                            
                            <!-- Variant Dropdown -->
                            <div class="flex-1 w-full sm:w-auto inline-flex flex-col items-start gap-2">
                                <label for="venue-variant-select" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-normal">
                                    Variant
                                </label>
                                <div class="relative self-stretch">
                                    <select id="venue-variant-select" class="w-full appearance-none p-3 outline outline-1 outline-Color-Neutral-Darkest text-Color-Neutral-Darkest text-base font-normal font-['Roboto'] leading-normal bg-white rounded">
                                        <option value="">Select</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quantity Input -->
                            <div class="w-full sm:w-auto inline-flex flex-col items-start gap-2">
                                <label for="venue-quantity" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-normal">
                                    Qty
                                </label>
                                <input type="number" id="venue-quantity" value="1" min="1" class="w-16 p-3 outline outline-1 outline-Color-Neutral-Darkest text-white text-base font-normal font-['Roboto'] leading-normal rounded">
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="self-stretch flex flex-col items-start gap-4 pt-2">
                        <button
                            type="button"
                            id="open-booking-modal"
                            data-authenticated="{{ user.is_authenticated|yesno:'true,false' }}"
                            data-login-url="/auth/login/?next={{ request.get_full_path|urlencode }}"
                            class="self-stretch px-6 py-3 bg-Color-Neutral-Darkest text-Color-White outline outline-1 outline-Color-Neutral-Darkest text-base font-normal font-['Roboto'] leading-normal rounded hover:bg-opacity-90 transition-colors"
                        >
                            Booking Venue
                        </button>
                        <button type="button" class="self-stretch px-6 py-3 text-Color-Neutral-Darkest outline outline-1 outline-Color-Neutral-Darkest text-base font-normal font-['Roboto'] leading-normal rounded hover:bg-gray-100 transition-colors">
                            Review Now
                        </button>
                        <span class="self-stretch text-center text-white text-xs font-normal font-['Roboto'] leading-none">
                            Free shipping over $50
                        </span>
                    </div>
                </div>

            </div>

            <!-- TESTIMONIALS SECTION -->
            <div class="w-full flex flex-col items-center gap-6 pt-10">
                
                <!-- Section Header -->
                <div class="w-full max-w-[768px] text-center flex flex-col items-center gap-6">
                    <h2 class="self-stretch text-white text-5xl font-bold font-['Roboto'] leading-[57.60px]">
                        Customer testimonials
                    </h2>
                    <p class="self-stretch text-white text-lg font-normal font-['Roboto'] leading-relaxed">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                    </p>
                </div>
                
                <!-- Testimonials Grid -->
                <div class="self-stretch grid grid-cols-1 md:grid-cols-3 gap-8 pt-6">
                    
                    <!-- Testimonial 1 -->
                    <div class="flex flex-col items-start gap-8">
                        <div class="inline-flex items-start gap-1 text-white">
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                        </div>
                        <blockquote class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">
                            "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse varius enim in eros elementum tristique. Duis cursus, mi quis viverra ornare."
                        </blockquote>
                        <div class="flex flex-col items-start gap-4">
                            <div class="flex flex-col items-start">
                                <cite class="not-italic text-white text-base font-semibold font-['Roboto'] leading-normal">
                                    Name Surname
                                </cite>
                                <span class="text-white text-base font-normal font-['Roboto'] leading-normal">
                                    Position, Company name
                                </span>
                            </div>
                            <div class="w-28 h-12 bg-gray-200"></div>
                        </div>
                    </div>
                    
                    <!-- Testimonial 2 -->
                    <div class="flex flex-col items-start gap-8">
                        <div class="inline-flex items-start gap-1 text-white">
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                        </div>
                        <blockquote class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">
                            "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse varius enim in eros elementum tristique. Duis cursus, mi quis viverra ornare."
                        </blockquote>
                        <div class="flex flex-col items-start gap-4">
                            <div class="flex flex-col items-start">
                                <cite class="not-italic text-white text-base font-semibold font-['Roboto'] leading-normal">
                                    Name Surname
                                </cite>
                                <span class="text-white text-base font-normal font-['Roboto'] leading-normal">
                                    Position, Company name
                                </span>
                            </div>
                            <div class="w-28 h-12 bg-gray-200"></div>
                        </div>
                    </div>
                    
                    <!-- Testimonial 3 -->
                    <div class="flex flex-col items-start gap-8">
                        <div class="inline-flex items-start gap-1 text-white">
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="..."/>
                            </svg>
                        </div>
                        <blockquote class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">
                            "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse varius enim in eros elementum tristique. Duis cursus, mi quis viverra ornare."
                        </blockquote>
                        <div class="flex flex-col items-start gap-4">
                            <div class="flex flex-col items-start">
                                <cite class="not-italic text-white text-base font-semibold font-['Roboto'] leading-normal">
                                    Name Surname
                                </cite>
                                <span class="text-white text-base font-normal font-['Roboto'] leading-normal">
                                    Position, Company name
                                </span>
                            </div>
                            <div class="w-28 h-12 bg-gray-200"></div>
                        </div>
                    </div>
                    
                </div>
            </div>

        </div>
    </div>
</div>

{% include "footer.html" %}

<div id="booking-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close-booking></div>
    <div class="relative z-10 mx-auto my-10 w-full max-w-2xl px-4">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between px-6 py-4 bg-[#3D5A80] text-white">
                <div>
                    <h2 class="text-2xl font-semibold">Book {{ venue.name }}</h2>
                    <p class="text-sm text-white/80">Secure your preferred time slot and play without worries.</p>
                </div>
                <button type="button" class="text-white/80 hover:text-white transition" data-close-booking aria-label="Close booking modal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-6 space-y-6">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2 text-[#3D5A80] font-semibold text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5h18M3 12h18M3 16.5h18M7.5 3v18M12 3v18M16.5 3v18" />
                        </svg>
                        <span>Rp{{ venue.price|intcomma }} <span class="text-sm font-normal text-gray-600">/ hour</span></span>
                    </div>
                    <div class="flex items-center gap-2 text-[#EE6C4D] font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2" />
                        </svg>
                        <span>{{ venue.type }}</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                    <label class="flex flex-col gap-2 text-sm font-medium text-gray-700">
                        Select Date
                        <input type="date" id="booking-date" class="w-full rounded-lg border border-gray-300 px-4 py-2 text-base focus:border-[#3D5A80] focus:ring-2 focus:ring-[#3D5A80]/40" required>
                    </label>
                    <label class="flex flex-col gap-2 text-sm font-medium text-gray-700">
                        Duration
                        <select id="booking-duration" class="w-full rounded-lg border border-gray-300 px-4 py-2 text-base focus:border-[#3D5A80] focus:ring-2 focus:ring-[#3D5A80]/40">
                            <option value="1">1 Hour</option>
                            <option value="2">2 Hours</option>
                            <option value="3">3 Hours</option>
                            <option value="4">4 Hours</option>
                            <option value="5">5 Hours</option>
                            <option value="6">6 Hours</option>
                        </select>
                    </label>
                </div>

                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">Available Time Slots</span>
                        <button type="button" id="refresh-availability" class="inline-flex items-center gap-1 text-sm text-[#3D5A80] hover:text-[#274472] transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5v6h6M19.5 19.5v-6h-6M5.25 18.75A8.25 8.25 0 0112 3.75a8.25 8.25 0 017.5 5.25" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div id="time-slot-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                    <p id="no-slots-message" class="hidden text-sm text-red-600">All slots for the selected date are booked. Please choose another date.</p>
                </div>

                <div id="booking-status" class="hidden rounded-lg px-4 py-3 text-sm"></div>

                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="text-lg font-semibold text-gray-800">
                        Total Price: <span id="booking-total-price">Rp{{ venue.price|intcomma }}</span>
                    </div>
                    <button id="submit-booking" type="button" class="inline-flex items-center justify-center gap-2 rounded-lg bg-[#EE6C4D] px-5 py-3 text-white font-semibold hover:bg-[#d95a3b] transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                        </svg>
                        Confirm Booking
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('booking-modal');
        const openButton = document.getElementById('open-booking-modal');
        const closeTriggers = modal ? modal.querySelectorAll('[data-close-booking]') : [];
        const dateInput = document.getElementById('booking-date');
        const durationSelect = document.getElementById('booking-duration');
        const timeSlotContainer = document.getElementById('time-slot-container');
        const noSlotsMessage = document.getElementById('no-slots-message');
        const statusBox = document.getElementById('booking-status');
        const totalPriceBox = document.getElementById('booking-total-price');
        const submitButton = document.getElementById('submit-booking');
        const refreshButton = document.getElementById('refresh-availability');

        if (!modal || !openButton || !dateInput || !durationSelect || !timeSlotContainer) {
            return;
        }

        const venueId = {{ venue.id }};
        const venuePrice = {{ venue.price }};
        const isAuthenticated = openButton.dataset.authenticated === 'true';
        const loginUrl = openButton.dataset.loginUrl;
        const OPERATING_HOURS = { start: 6, end: 22 };
        const TIME_SLOTS = Array.from({ length: OPERATING_HOURS.end - OPERATING_HOURS.start }, (_, index) => {
            const hour = OPERATING_HOURS.start + index;
            return `${hour.toString().padStart(2, '0')}:00`;
        });

        let currentAvailability = null;
        let selectedStartTime = null;

        const setTodayDate = () => {
            const today = new Date();
            const iso = today.toISOString().split('T')[0];
            dateInput.min = iso;
            if (!dateInput.value) {
                dateInput.value = iso;
            }
        };

        const openModal = () => {
            if (!isAuthenticated) {
                window.location.href = loginUrl;
                return;
            }
            setTodayDate();
            statusBox.classList.add('hidden');
            statusBox.textContent = '';
            selectedStartTime = null;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            fetchAvailability(dateInput.value);
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        };

        const updateTotalPrice = () => {
            const duration = parseInt(durationSelect.value, 10) || 1;
            const total = duration * venuePrice;
            totalPriceBox.textContent = `Rp${total.toLocaleString('id-ID')}`;
        };

        const timeStringToMinutes = (value) => {
            const [hour, minute] = value.split(':').map(Number);
            return hour * 60 + minute;
        };

        const isSlotAvailable = (startValue, duration, booked) => {
            const startMinutes = timeStringToMinutes(startValue);
            const endMinutes = startMinutes + duration * 60;
            if (endMinutes > OPERATING_HOURS.end * 60) {
                return false;
            }
            return !booked.some(slot => startMinutes < slot.end && endMinutes > slot.start);
        };

        const renderSlots = (availability) => {
            currentAvailability = availability;
            const duration = parseInt(durationSelect.value, 10) || 1;
            const bookedIntervals = availability.booked_slots.map(slot => ({
                start: timeStringToMinutes(slot.start_time),
                end: timeStringToMinutes(slot.end_time),
            }));

            timeSlotContainer.innerHTML = '';
            let slotsRendered = 0;

            TIME_SLOTS.forEach(slotValue => {
                if (!isSlotAvailable(slotValue, duration, bookedIntervals)) {
                    return;
                }

                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.timeValue = slotValue;
                button.textContent = slotValue;
                button.className = 'px-4 py-2 rounded-lg border border-[#3D5A80] text-[#3D5A80] hover:bg-[#3D5A80] hover:text-white transition';

                if (slotValue === selectedStartTime) {
                    button.classList.add('bg-[#3D5A80]', 'text-white');
                }

                button.addEventListener('click', () => {
                    selectedStartTime = slotValue;
                    Array.from(timeSlotContainer.querySelectorAll('button')).forEach(btn => btn.classList.remove('bg-[#3D5A80]', 'text-white'));
                    button.classList.add('bg-[#3D5A80]', 'text-white');
                    statusBox.classList.add('hidden');
                });

                timeSlotContainer.appendChild(button);
                slotsRendered += 1;
            });

            if (slotsRendered === 0) {
                noSlotsMessage.classList.remove('hidden');
            } else {
                noSlotsMessage.classList.add('hidden');
            }

            if (selectedStartTime) {
                const stillAvailable = Array.from(timeSlotContainer.querySelectorAll('button')).some(btn => btn.dataset.timeValue === selectedStartTime);
                if (!stillAvailable) {
                    selectedStartTime = null;
                }
            }
        };

        const fetchAvailability = (date) => {
            if (!date) {
                return;
            }
            timeSlotContainer.innerHTML = '<p class="col-span-full text-sm text-gray-500">Loading available slots...</p>';
            noSlotsMessage.classList.add('hidden');

            fetch(`/booking/venue/${venueId}/availability/?date=${date}`)
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => {
                    renderSlots(data);
                })
                .catch(() => {
                    timeSlotContainer.innerHTML = '<p class="col-span-full text-sm text-red-600">Unable to fetch availability. Please try again later.</p>';
                });
        };

        const getCsrfToken = () => {
            const cookie = document.cookie.split(';').map(item => item.trim()).find(item => item.startsWith('csrftoken='));
            return cookie ? decodeURIComponent(cookie.split('=')[1]) : '';
        };

        const submitBooking = () => {
            if (!selectedStartTime) {
                statusBox.textContent = 'Please choose a time slot before confirming your booking.';
                statusBox.className = 'rounded-lg px-4 py-3 text-sm bg-red-100 text-red-700';
                statusBox.classList.remove('hidden');
                return;
            }

            const payload = {
                date: dateInput.value,
                start_time: selectedStartTime,
                duration_hours: parseInt(durationSelect.value, 10) || 1,
            };

            submitButton.disabled = true;
            submitButton.classList.add('opacity-75');

            fetch(`/booking/venue/${venueId}/book/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify(payload),
            })
                .then(response => response.json().then(data => ({ status: response.status, data })))
                .then(({ status, data }) => {
                    if (status === 201) {
                        statusBox.textContent = 'Booking confirmed! You can review it from your My Bookings page.';
                        statusBox.className = 'rounded-lg px-4 py-3 text-sm bg-green-100 text-green-700';
                        statusBox.classList.remove('hidden');
                        fetchAvailability(dateInput.value);
                    } else {
                        const message = data.error || 'We could not complete your booking. Please try another time slot.';
                        statusBox.textContent = message;
                        statusBox.className = 'rounded-lg px-4 py-3 text-sm bg-red-100 text-red-700';
                        statusBox.classList.remove('hidden');
                    }
                })
                .catch(() => {
                    statusBox.textContent = 'An unexpected error occurred. Please try again later.';
                    statusBox.className = 'rounded-lg px-4 py-3 text-sm bg-red-100 text-red-700';
                    statusBox.classList.remove('hidden');
                })
                .finally(() => {
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-75');
                });
        };

        openButton.addEventListener('click', openModal);
        closeTriggers.forEach(trigger => trigger.addEventListener('click', closeModal));
        dateInput.addEventListener('change', () => fetchAvailability(dateInput.value));
        durationSelect.addEventListener('change', () => {
            updateTotalPrice();
            if (currentAvailability) {
                renderSlots(currentAvailability);
            }
        });
        if (refreshButton) {
            refreshButton.addEventListener('click', () => fetchAvailability(dateInput.value));
        }
        submitButton.addEventListener('click', submitBooking);

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        updateTotalPrice();
    });
</script>
{% endblock extra_js %}
